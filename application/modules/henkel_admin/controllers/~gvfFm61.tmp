<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Henkel_adm_lap_penerima_komisi_sales extends CI_Controller {

	public function __construct()
	{
	    parent::__construct();
      $this->load->model('model_lap_komisi');
	}

	public function index()
	{
		$cek = $this->session->userdata('logged_in');
		if(!empty($cek)){
			$d['judul']="Laporan Komisi (Sales/Supervisor/Operational Manager)";
			$d['class'] = "penjualan";
			$d['data_perusahaan'] = '';
			$d['data'] = $this->model_lap_komisi->all_sales();
			$d['content']= 'komisi_penjualan/rekap_komisi/view_komisi_sales';
			$this->load->view('henkel_adm_home',$d);
		}else{
			redirect('henkel','refresh');
		}
	}

	public function cari_komisi_sales(){
		$cek 	= $this->session->userdata('logged_in');
		$level 	= $this->session->userdata('level');
		if(!empty($cek) && $level=='henkel_admin'){
			$id['id_penerima_komisi_sales']	= $this->input->get('cari');

			if($this->model_lap_komisi->ada_sales($id)) {
				$dt = $this->model_lap_komisi->get_sales($id);

				$d['id_penerima_komisi_sales']	= $dt->id_penerima_komisi_sales;
				$d['tgl_awal']	= $dt->tgl_awal;
				$d['tgl_akhir']	= $dt->tgl_akhir;
				echo json_encode($d);
			} else {
				$d['id_penerima_komisi_sales']		= '';
				$d['tgl_awal']  	= '';
				$d['tgl_akhir']  	= '';
				echo json_encode($d);
			}
		}
		else {
			redirect('henkel','refresh');
		}
	}

	public function cetak_pdf_komisi_sales()
	{
		$cek = $this->session->userdata('logged_in');
		if(!empty($cek)){
			$id_penerima_komisi_sales  = $this->input->get('id_penerima_komisi_sales');
			$tgl_awal  = $this->input->get('tgl_awal');
			$tgl_akhir  = $this->input->get('tgl_akhir');
			$q = $this->db_kpp->select('pksd.nik, pksd.nama_karyawan, pksd.status_komisi, pksd.status_target_penjualan, pks.tgl_awal, pks.tgl_akhir')
												->from('penerima_komisi_sales_detail pksd')
												->join('penerima_komisi_sales pks', 'pks.id_penerima_komisi_sales = pksd.id_penerima_komisi_sales')
												->where('pks.id_penerima_komisi_sales', $id_penerima_komisi_sales)
												->group_by('pksd.nama_karyawan')
												->get();
 			$data_total_akhir = $this->db_kpp->query("SELECT pp.total_akhir, pp.tgl, pp.tgl_lunas, pp.kode_sales, gp.nama_group
																								FROM pesanan_penjualan pp
																								JOIN pelanggan p ON p.kode_pelanggan=pp.kode_pelanggan
																								JOIN group_pelanggan gp ON gp.kode_group_pelanggan=p.kode_group_pelanggan
																								WHERE (pp.tgl BETWEEN '$tgl_awal' AND '$tgl_akhir') AND pp.status='Lunas'
			   																			 ");
			$r = $q->num_rows();
			if($r>0){
				define('FPDF_FONTPATH', $this->config->item('fonts_path'));
				require(APPPATH.'plugins/fpdf.php');


			  $pdf=new FPDF();
			  $pdf->AddPage("L","A4");
				//foreach($data->result() as $t){
					$A4[0]=210;
					$A4[1]=297;
					$Q[0]=216;
					$Q[1]=279;
					$pdf->SetTitle('Laporan Komisi Sales/Supervisor/Operational Manager');
					$pdf->SetCreator('Programmer IT with fpdf');

					$h = 7;
					$pdf->SetFont('Times','B', 14);
					$pdf->Image('assets/img/kumala.png',10,6,20);
					$pdf->SetX(33);

					$pdf->Cell(198,4,'PT. KUMALA MOTOR GROUP',0,1,'L');
					$pdf->Ln(2);
					$pdf->SetX(33);
					$pdf->SetFont('Times','',10);
					$pdf->Cell(198,4,$this->config->item('alamat_instansi'),0,1,'L');
					$pdf->SetX(33);
					$pdf->Cell(198,4,$this->config->item('phone'),0,1,'L');
					$pdf->SetX(33);
					$pdf->Cell(198,4,$this->config->item('fax'),0,1,'L');
					$pdf->Line(10, 33, 300-10, 33);

					$pdf->Ln(10);

					//Column widths
					$pdf->SetFont('Times','B',11);
					$pdf->SetX(6);
					$pdf->Cell(190,4,'Laporan Komisi Sales/Supervisor/Operational Manager',0,1,'C');
					$pdf->Ln(2);
					$pdf->SetFont('Times','',10);
					$pdf->SetX(6);
					$pdf->Cell(190,4,'Dari Tanggal '.tgl_indo($tgl_awal).' s/d Tanggal '.tgl_indo($tgl_akhir).'',0,1,'C');

					$pdf->Ln(5);

					$w = array(8,15,45,22,30,45);
					$pdf->SetFont('Times','B',10);
					$pdf->SetX(10);
					$pdf->Cell(35,4,'Laporan Komisi Sales',0,1,'C');
					$pdf->Ln(2);
					//Header
					$pdf->SetFont('Times','B',10);
					$pdf->Cell($w[0],$h,'No',1,0,'C');
					$pdf->Cell($w[1],$h,'NIK',1,0,'C');
					$pdf->Cell($w[2],$h,'Nama Karyawan',1,0,'C');
					$pdf->Cell($w[3],$h,'Komisi',1,0,'C');
					$pdf->Cell($w[4],$h,'Level Sales',1,0,'C');
					$pdf->Cell($w[5],$h,'Jumlah Insentif',1,0,'C');
					$pdf->Ln();
					$pdf->SetFont('Times','',8);
					$pdf->SetFillColor(204,204,204);
    			$pdf->SetTextColor(0);
					$fill = false;
					$no=1;
					foreach($q->result() as $row){
						$jumlah_insentif1=0;
		        $jumlah_insentif2=0;
		        $take2=0;
						$nama_target='';
						foreach ($data_total_akhir->result() as $dta_a) {
						     $total_akhir=0;
						     $datetime1 = new DateTime($dta_a->tgl);
						     $datetime2 = new DateTime($dta_a->tgl_lunas);
						     $interval = $datetime1->diff($datetime2);
						     $umur_hutang_total = $interval->format('%a');

						     $status_komisi = $row->status_komisi;
						     $status_target_penjualan = $row->status_target_penjualan;

						     $total_akhir += $dta_a->total_akhir;
						}
						$data_status_target_penjualan = $this->db_kpp->query("SELECT * FROM target_penjualan_detail WHERE id_target_penjualan_detail='$status_target_penjualan'");
	          $data_status_komisi = $this->db_kpp->query("SELECT ks.*, k.nama_komisi FROM komisi_sales ks JOIN komisi k ON ks.id_komisi=k.id_komisi WHERE ks.id_komisi='$status_komisi'");
						foreach ($data_total_akhir->result() as $dta_b) {
		        $jumlah_insentif=0;
		          foreach ($data_status_target_penjualan->result() as $dstp) {
								$nama_target_penjualan=$dstp->nama_target;
		            foreach ($data_status_komisi->result() as $dsk) {
									$nama_komisi=$dsk->nama_komisi;
		                if ($row->nik==$dta_b->kode_sales && $umur_hutang_total>=$dsk->range_hari_awal && $umur_hutang_total<=$dsk->range_hari_akhir && $total_akhir>=$dstp->jumlah_target) {
		                  $jumlah_insentif = ($dsk->target_capai*$total_akhir)/100;
		                } elseif ($row->nik==$dta_b->kode_sales && $umur_hutang_total>=$dsk->range_hari_awal && $umur_hutang_total<=$dsk->range_hari_akhir && $total_akhir<$dstp->jumlah_target) {
		                  $jumlah_insentif = ($dsk->target_tidakcapai*$total_akhir)/100;
		                }
		      			 }
		           }
		         }

						$pdf->Cell($w[0],$h,$no,'LR',0,'C',$fill);
						$pdf->Cell($w[1],$h,$row->nik,'LR',0,'C',$fill);
						$pdf->Cell($w[2],$h,$row->nama_karyawan,'LR',0,'C',$fill);
						$pdf->Cell($w[3],$h,$nama_komisi,'LR',0,'C',$fill);
						$pdf->Cell($w[4],$h,$nama_target_penjualan,'LR',0,'C',$fill);
						$pdf->Cell($w[5],$h,'Rp. '.separator_harga2($jumlah_insentif),'LR',0,'C',$fill);
						/*foreach ($data_satuan->result() as $ds) {
								if ($row->persentase2!=0) {
									$take2 += (($ds->total*$ds->insentif_pcs)*$row->persentase1)/100;
									$jumlah_insentif2 = ($take2*$row->persentase2)/100;
								} elseif ($row->persentase2==0) {
									$jumlah_insentif1 += (($ds->total*$ds->insentif_pcs)*$row->persentase1)/100;
								}
						}
						 if ($row->persentase2!=0) {
							 $pdf->Cell($w[6],$h,'Rp. '.separator_harga2($jumlah_insentif2),'LR',0,'C',$fill);
						} else {
							 $pdf->Cell($w[6],$h,'Rp. '.separator_harga2($jumlah_insentif1),'LR',0,'C',$fill);
						}*/
						$pdf->Ln();
						$fill = !$fill;
						$no++;
					}
					// Closing line
					$pdf->Cell(array_sum($w),0,'','T');
					$pdf->Ln(5);
					$pdf->SetFont('Times','B',10);
					$pdf->SetX(8);
					$pdf->Cell(80,4,'Laporan Komisi Supervisor/Operational Manager',0,1,'C');
					$pdf->Ln(2);
					$_om0=0;
		      $_spv0=0;
		      $_om1=0;
		      $_spv1=0;
		      $_om2=0;
		      $_spv2=0;
		      $_om3=0;
		      $_spv3=0;
		      $_om4=0;
		      $_spv4=0;
					foreach ($data_total_akhir->result() as $dta_c) {
		        $_retail0=0;
		        $_toko0=0;
		        $_retail1=0;
		        $_toko1=0;
		        $_retail2=0;
		        $_toko2=0;
		        $_retail3=0;
		        $_toko3=0;
		        $_retail4=0;
		        $_toko4=0;
		        $datetime1 = new DateTime($dta_c->tgl);
		        $datetime2 = new DateTime($dta_c->tgl_lunas);
		        $interval = $datetime1->diff($datetime2);
		        $umur_hutang_total_c = $interval->format('%a');
		        $nama_group = strtolower($dta_c->nama_group);
		        if ($umur_hutang_total_c>=0 && $umur_hutang_total_c<=60) {
		          if ($nama_group='retail') {
		              $_retail0+=$dta_c->total_akhir;
		          } elseif ($nama_group='toko') {
		              $_toko0+=$dta_c->total_akhir;
		          }
		        } elseif ($umur_hutang_total_c>=61 && $umur_hutang_total_c<=90) {
		          if ($nama_group='retail') {
		              $_retail1+=$dta_c->total_akhir;
		          } elseif ($nama_group='toko') {
		              $_toko1+=$dta_c->total_akhir;
		          }
		        } elseif ($umur_hutang_total_c>=91 && $umur_hutang_total_c<=120) {
		          if ($nama_group='retail') {
		              $_retail2+=$dta_c->total_akhir;
		          } elseif ($nama_group='toko') {
		              $_toko2+=$dta_c->total_akhir;
		          }
		        } elseif ($umur_hutang_total_c>=121 && $umur_hutang_total_c<=150) {
		          if ($nama_group='retail') {
		              $_retail3+=$dta_c->total_akhir;
		          } elseif ($nama_group='toko') {
		              $_toko3+=$dta_c->total_akhir;
		          }
		        } elseif ($umur_hutang_total_c>=151) {
		          if ($nama_group='retail') {
		              $_retail4+=$dta_c->total_akhir;
		          } elseif ($nama_group='toko') {
		              $_toko4+=$dta_c->total_akhir;
		          }
		        }
		      }
					$pdf->SetX(10);
					$l = array(8,25,35,13,12,30,12,13,55,55);
					$pdf->Cell($l[0],$h,'No',1,0,'C');
					$pdf->Cell($l[1],$h,'TOP (Lunas)',1,0,'C');
					$pdf->Cell($l[2],$h,'Retail',1,0,'C');
					$pdf->Cell($l[3],$h,'OM',1,0,'C');
					$pdf->Cell($l[4],$h,'SPV',1,0,'C');
					$pdf->Cell($l[5],$h,'Toko',1,0,'C');
					$pdf->Cell($l[6],$h,'OM',1,0,'C');
					$pdf->Cell($l[7],$h,'SPV',1,0,'C');
					$pdf->Cell($l[8],$h,'Total Insentif (OM)',1,0,'C');
					$pdf->Cell($l[9],$h,'Total Insentif (SPV)',1,0,'C');
					$pdf->SetFont('Times','',8);
					$pdf->Ln(7);
					$pdf->Cell($l[0],$h,'1',1,0,'C');
					$pdf->Cell($l[1],$h,'0-60 Hari',1,0,'C');
					$pdf->Cell($l[2],$h,'Rp. '.separator_harga2($_retail0),1,0,'C');
					$pdf->Cell($l[3],$h,'0,30%',1,0,'C');
					$pdf->Cell($l[4],$h,'0,10%',1,0,'C');
					$pdf->Cell($l[5],$h,'Rp. '.separator_harga2($_toko0),1,0,'C');
					$pdf->Cell($l[6],$h,'0,30%',1,0,'C');
					$pdf->Cell($l[7],$h,'0,10%',1,0,'C');
					$_om0=($_retail0*0.30)/100+($_toko0*0.10)/100;
					$pdf->Cell($l[8],$h,'Rp. '.separator_harga2($_om0),1,0,'C');
					$_spv0=($_retail0*0.30)/100+($_toko0*0.10)/100;
					$pdf->Cell($l[9],$h,'Rp. '.separator_harga2($_spv0),1,0,'C');
					$pdf->Ln(7);
					$pdf->Cell($l[0],$h,'2',1,0,'C');
					$pdf->Cell($l[1],$h,'61-90 Hari',1,0,'C');
					$pdf->Cell($l[2],$h,'Rp. '.separator_harga2($_retail1),1,0,'C');
					$pdf->Cell($l[3],$h,'0,30%',1,0,'C');
					$pdf->Cell($l[4],$h,'0,10%',1,0,'C');
					$pdf->Cell($l[5],$h,'Rp. '.separator_harga2($_toko1),1,0,'C');
					$pdf->Cell($l[6],$h,'0,20%',1,0,'C');
					$pdf->Cell($l[7],$h,'0,08%',1,0,'C');
					$_om1=($_retail1*0.30)/100+($_toko1*0.10)/100;
					$pdf->Cell($l[8],$h,'Rp. '.separator_harga2($_om1),1,0,'C');
					$_spv1=($_retail1*0.30)/100+($_toko1*0.10)/100;
					$pdf->Cell($l[9],$h,'Rp. '.separator_harga2($_spv1),1,0,'C');
					$pdf->Ln(7);
					$pdf->Cell($l[0],$h,'3',1,0,'C');
					$pdf->Cell($l[1],$h,'91-120 Hari',1,0,'C');
					$pdf->Cell($l[2],$h,'Rp. '.separator_harga2($_retail2),1,0,'C');
					$pdf->Cell($l[3],$h,'0,20%',1,0,'C');
					$pdf->Cell($l[4],$h,'0,10%',1,0,'C');
					$pdf->Cell($l[5],$h,'Rp. '.separator_harga2($_toko2),1,0,'C');
					$pdf->Cell($l[6],$h,'0,10%',1,0,'C');
					$pdf->Cell($l[7],$h,'0,05%',1,0,'C');
					$_om2=($_retail2*0.20)/100+($_toko2*0.10)/100;
					$pdf->Cell($l[8],$h,'Rp. '.separator_harga2($_om2),1,0,'C');
					$_spv2=($_retail2*0.10)/100+($_toko2*0.05)/100;
					$pdf->Cell($l[9],$h,'Rp. '.separator_harga2($_spv2),1,0,'C');
					$pdf->Ln(7);
					$pdf->Cell($l[0],$h,'4',1,0,'C');
					$pdf->Cell($l[1],$h,'121-150 Hari',1,0,'C');
					$pdf->Cell($l[2],$h,'Rp. '.separator_harga2($_retail3),1,0,'C');
					$pdf->Cell($l[3],$h,'0,10%',1,0,'C');
					$pdf->Cell($l[4],$h,'0%',1,0,'C');
					$pdf->Cell($l[5],$h,'Rp. '.separator_harga2($_toko3),1,0,'C');
					$pdf->Cell($l[6],$h,'0,05%',1,0,'C');
					$pdf->Cell($l[7],$h,'0%',1,0,'C');
					$_om3=($_retail3*0.10)/100+($_toko3*0.05)/100;
					$pdf->Cell($l[8],$h,'Rp. '.separator_harga2($_om3),1,0,'C');
					$_spv3=($_retail3*0)/100+($_toko3*0)/100;
					$pdf->Cell($l[9],$h,'Rp. '.separator_harga2($_spv3),1,0,'C');
					$pdf->Ln(7);
					$pdf->Cell($l[0],$h,'5',1,0,'C');
					$pdf->Cell($l[1],$h,'151 Hari',1,0,'C');
					$pdf->Cell($l[2],$h,'Rp. '.separator_harga2($_retail4),1,0,'C');
					$pdf->Cell($l[3],$h,'0%',1,0,'C');
					$pdf->Cell($l[4],$h,'0%',1,0,'C');
					$pdf->Cell($l[5],$h,'Rp. '.separator_harga2($_toko4),1,0,'C');
					$pdf->Cell($l[6],$h,'0%',1,0,'C');
					$pdf->Cell($l[7],$h,'0%',1,0,'C');
					$_om4=($_retail4*0.10)/100+($_toko4*0.05)/100;
					$pdf->Cell($l[8],$h,'Rp. '.separator_harga2($_om4),1,0,'C');
					$_spv4=($_retail4*0)/100+($_toko4*0)/100;
					$pdf->Cell($l[9],$h,'Rp. '.separator_harga2($_spv4),1,0,'C');


					$pdf->SetFont('Times','B',10);
					$pdf->Ln(10);
					$pdf->SetFont('Times','',8);
					$pdf->SetX(150);
					$pdf->Cell(100,$h,'Makassar, '. tgl_indo(date('Y-m-d')),'C');
					$pdf->Ln(20);
					$pdf->SetX(150);
					$pdf->Cell(100,$h,'______________________','C');
				//}

				//}
				$pdf->Output('Lap_Pembelian - '.date('d-m-Y').'.pdf','I');
			}else{
				redirect('henkel_adm_lap_pembelian');
			}

		}else{
			redirect('henkel','refresh');
		}
	}

	public function cetak_excel_komisi_admin(){
		$cek = $this->session->userdata('logged_in');
		$level = $this->session->userdata('level');
		if(!empty($cek) && $level=='henkel_admin'){
			$id_penerima_komisi_admin  = $this->input->get('id_penerima_komisi_admin');
			$q = $this->db_kpp->select('pka.tgl_awal, pka.tgl_akhir, pkad.nik, pkad.nama_karyawan, pkad.status_komisi, pkad.persentase1, pkad.persentase2')
												->from('penerima_komisi_admin pka')
												->join('penerima_komisi_admin_detail pkad', 'pka.id_penerima_komisi_admin = pkad.id_penerima_komisi_admin')
												->get();
			foreach($q->result() as $row_ket){
				$tgl_awal = $row_ket->tgl_awal;
				$tgl_akhir = $row_ket->tgl_akhir;
				$status_komisi = $row_ket->status_komisi;
				$data_status_komisi = $this->db_kpp->select('nama_komisi')
				   																 ->from('komisi')
										 											 ->where('id_komisi', $status_komisi)
										 											 ->get();
				$data_satuan = $this->db_kpp->query("SELECT s.id_satuan, COUNT(s.id_satuan) AS total, ka.insentif_pcs
																			       FROM pesanan_penjualan pp
																			       JOIN penjualan p ON p.id_pesanan_penjualan=pp.id_pesanan_penjualan
																			       JOIN item o ON o.kode_item=p.kode_item
																			       JOIN satuan s ON s.kode_satuan=o.kode_satuan
																			       JOIN komisi_admin ka ON ka.id_satuan=s.id_satuan
																			       WHERE (pp.tgl BETWEEN '$tgl_awal' AND '$tgl_akhir') AND ka.id_komisi='$status_komisi'
																			       GROUP BY s.id_satuan
																			      ");
									      }
				$r = $q->num_rows();
        if($r>0){
            $objPHPExcel = new PHPExcel();
            // Set properties
            $objPHPExcel->getProperties()
                  			->setCreator("IT Kumala Motor Group") //creator
                    		->setTitle("Export Excel Data Komisi Admin/Gudang");  //file title

            $objset = $objPHPExcel->setActiveSheetIndex(0); //inisiasi set object
            $objget = $objPHPExcel->getActiveSheet();  //inisiasi get object

            $objget->setTitle('Laporan Komisi Admin & Gudang'); //sheet title

            //table header
            $cols = array("A","B","C","D","E","F","G");

            $val = array("NO","NIK","Nama Karyawan","Komisi","Persentase 1","Persentase 2 (Admin)","Jumlah Insentif");

            for ($a=0;$a<7; $a++)
            {
                $objset->setCellValue($cols[$a].'1', $val[$a]);

                //Setting lebar cell
                $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(5);
                $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(25);
                $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(25);
								$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(25);
								$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(25);
								$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(25);
								$objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(25);

                $style = array(
                    'alignment' => array(
                        'horizontal' => PHPExcel_Style_Alignment::VERTICAL_CENTER,
                    )
                );
                $objPHPExcel->getActiveSheet()->getStyle($cols[$a].'1')->applyFromArray($style);
            }

            $baris=2;
						$i=1;
            foreach ($q->result() as $row){
							$jumlah_insentif1=0;
			        $jumlah_insentif2=0;
			        $take2=0;
							$objset->setCellValue("A".$baris, $i++);
							$objset->setCellValue("B".$baris, $row->nik);
							$objset->setCellValue("C".$baris, $row->nama_karyawan);
							foreach ($data_status_komisi->result() as $dsk) {
								$nama_komisi = $dsk->nama_komisi;
							}
							$objset->setCellValue("D".$baris, $nama_komisi);
							$objset->setCellValue("E".$baris, $row->persentase1);
							$objset->setCellValue("F".$baris, $row->persentase2);
							foreach ($data_satuan->result() as $ds) {
									if ($row->persentase2!=0) {
										$take2 += (($ds->total*$ds->insentif_pcs)*$row->persentase1)/100;
										$jumlah_insentif2 = ($take2*$row->persentase2)/100;
									} elseif ($row->persentase2==0) {
										$jumlah_insentif1 += (($ds->total*$ds->insentif_pcs)*$row->persentase1)/100;
									}
							}
							if ($row->persentase2!=0) {
								$objset->setCellValue("G".$baris, 'Rp. '.separator_harga2($jumlah_insentif2));
						  } else {
								$objset->setCellValue("G".$baris, 'Rp. '.separator_harga2($jumlah_insentif1));
						  }
                //Set number value
                $objPHPExcel->getActiveSheet()->getStyle('C1:C'.$baris)->getNumberFormat()->setFormatCode('0');

                $baris++;
            }

            $objPHPExcel->getActiveSheet()->setTitle('Data Export');

            $objPHPExcel->setActiveSheetIndex(0);
            $filename = urlencode("Data Laporan Komisi Admin/Gudang".date("Y-m-d H:i:s").".xls");

              header('Content-Type: application/vnd.ms-excel'); //mime type
              header('Content-Disposition: attachment;filename="'.$filename.'"'); //tell browser what's the file name
              header('Cache-Control: max-age=0'); //no cache

            $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');
            $objWriter->save('php://output');
        }else{
					redirect('henkel_adm_lap_penerima_komisi_admin', 'refresh');
        }
			}else{
				redirect('henkel','refresh');
			}
	}
}

/* End of file welcome.php */
/* Location: ./application/controllers/welcome.php */
